<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>9 Cluster randomised trials | Clinical Trials 4H - lecture notes</title>
  <meta name="description" content="These notes mirror what we’ll follow in lectures for Clinical Trials 4H. If you have any questions or notice any errors, please email me (Rachel Oughton)." />
  <meta name="generator" content="bookdown 0.42 and GitBook 2.6.7" />

  <meta property="og:title" content="9 Cluster randomised trials | Clinical Trials 4H - lecture notes" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="These notes mirror what we’ll follow in lectures for Clinical Trials 4H. If you have any questions or notice any errors, please email me (Rachel Oughton)." />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="9 Cluster randomised trials | Clinical Trials 4H - lecture notes" />
  
  <meta name="twitter:description" content="These notes mirror what we’ll follow in lectures for Clinical Trials 4H. If you have any questions or notice any errors, please email me (Rachel Oughton)." />
  

<meta name="author" content="Rachel Oughton" />


<meta name="date" content="2025-01-25" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="lecture-16-comparing-survival-curves.html"/>
<link rel="next" href="references.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/font-awesome-6.5.2/css/all.min.css" rel="stylesheet" />
<link href="libs/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet" />
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<link href="libs/bsTable-3.3.7/bootstrapTable.min.css" rel="stylesheet" />
<script src="libs/bsTable-3.3.7/bootstrapTable.js"></script>
<link href="libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="libs/pagedtable-1.1/js/pagedtable.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="rct-plan.html"><a href="rct-plan.html"><i class="fa fa-check"></i><b>2</b> (Lecture 2) Sample size</a>
<ul>
<li class="chapter" data-level="2.1" data-path="rct-plan.html"><a href="rct-plan.html#the-treatment-effect"><i class="fa fa-check"></i><b>2.1</b> The treatment effect</a></li>
<li class="chapter" data-level="2.2" data-path="rct-plan.html"><a href="rct-plan.html#reminder-hypothesis-tests-with-a-focus-on-rcts"><i class="fa fa-check"></i><b>2.2</b> Reminder: hypothesis tests (with a focus on RCTs)</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="rct-plan.html"><a href="rct-plan.html#one-sided-or-two-sided"><i class="fa fa-check"></i><b>2.2.1</b> One-sided or two-sided?</a></li>
<li class="chapter" data-level="2.2.2" data-path="rct-plan.html"><a href="rct-plan.html#insignificant-results"><i class="fa fa-check"></i><b>2.2.2</b> Insignificant results</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="rct-plan.html"><a href="rct-plan.html#sec-measDcont"><i class="fa fa-check"></i><b>2.3</b> Constructing a measure of effect size</a>
<ul>
<li class="chapter" data-level="" data-path="rct-plan.html"><a href="rct-plan.html#brief-aside-on-notation"><i class="fa fa-check"></i>Brief aside on notation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="lecture-3.html"><a href="lecture-3.html"><i class="fa fa-check"></i>Lecture 3</a>
<ul>
<li class="chapter" data-level="2.4" data-path="lecture-3.html"><a href="lecture-3.html#sec-power"><i class="fa fa-check"></i><b>2.4</b> Power: If <span class="math inline">\(H_0\)</span> is false</a></li>
<li class="chapter" data-level="2.5" data-path="lecture-3.html"><a href="lecture-3.html#sec-ssformulacont"><i class="fa fa-check"></i><b>2.5</b> A sample size formula</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="lecture-4-allocation.html"><a href="lecture-4-allocation.html"><i class="fa fa-check"></i><b>3</b> (Lecture 4) Allocation</a>
<ul>
<li class="chapter" data-level="3.1" data-path="lecture-4-allocation.html"><a href="lecture-4-allocation.html#bias"><i class="fa fa-check"></i><b>3.1</b> Bias</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="lecture-4-allocation.html"><a href="lecture-4-allocation.html#sources-of-bias"><i class="fa fa-check"></i><b>3.1.1</b> Sources of bias</a></li>
<li class="chapter" data-level="3.1.2" data-path="lecture-4-allocation.html"><a href="lecture-4-allocation.html#implications-for-allocation"><i class="fa fa-check"></i><b>3.1.2</b> Implications for allocation</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="lecture-4-allocation.html"><a href="lecture-4-allocation.html#sec-allocation"><i class="fa fa-check"></i><b>3.2</b> (Lecture 5) Allocation methods</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="lecture-4-allocation.html"><a href="lecture-4-allocation.html#simple-random-allocation"><i class="fa fa-check"></i><b>3.2.1</b> Simple random allocation</a></li>
<li class="chapter" data-level="3.2.2" data-path="lecture-4-allocation.html"><a href="lecture-4-allocation.html#random-permuted-blocks"><i class="fa fa-check"></i><b>3.2.2</b> Random permuted blocks</a></li>
<li class="chapter" data-level="3.2.3" data-path="lecture-4-allocation.html"><a href="lecture-4-allocation.html#biased-coin-designs-and-urn-schemes"><i class="fa fa-check"></i><b>3.2.3</b> Biased coin designs and urn schemes</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="lecture-4-allocation.html"><a href="lecture-4-allocation.html#lecture-6-incorporating-baseline-measurements"><i class="fa fa-check"></i><b>3.3</b> (Lecture 6) Incorporating baseline measurements</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="lecture-4-allocation.html"><a href="lecture-4-allocation.html#stratified-sampling"><i class="fa fa-check"></i><b>3.3.1</b> Stratified sampling</a></li>
<li class="chapter" data-level="3.3.2" data-path="lecture-4-allocation.html"><a href="lecture-4-allocation.html#minimization"><i class="fa fa-check"></i><b>3.3.2</b> Minimization</a></li>
<li class="chapter" data-level="3.3.3" data-path="lecture-4-allocation.html"><a href="lecture-4-allocation.html#minimization-algorithm"><i class="fa fa-check"></i><b>3.3.3</b> Minimization algorithm</a></li>
</ul></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Clinical Trials 4H - lecture notes</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="cluster-rct" class="section level1 hasAnchor" number="9">
<h1><span class="header-section-number">9</span> Cluster randomised trials<a href="cluster-rct.html#cluster-rct" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>For the trials we’ve been studying so far, the intervention is applied at an individual level.</p>
<p><em>Often realistic, for example a medicine, injection or operation</em>.</p>
<p>However, for some treatments this is not practical, eg. a new cleaning regime in operating theatres.</p>
<p><em>Almost impossible to implement this if different patients within the same hospital would be allocated to different cleaning styles.</em></p>
<p><em>Logistically it would be very difficult, and there would likely be contamination as staff may be reluctant to clean an operating theatre in what might now seem an inferior way, for a control participant. In general it is very difficult (if not impossible) to implement changes in practice across healthcare systems at an individual level.</em></p>
<p>The solution to this is to work at the group level, rather than the individual level.</p>
<div id="what-is-a-cluster-rct" class="section level2 hasAnchor" number="9.1">
<h2><span class="header-section-number">9.1</span> What is a cluster RCT?<a href="cluster-rct.html#what-is-a-cluster-rct" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In a cluster RCT, participants within the same natural group (eg. doctor’s surgery, hospital, school, classroom,…) are all allocated to the same group together.</p>
<p><em>This means that, in the cleaning example above, the staff at a hospital in the treatment group can be trained in the new practice, all patients at that hospital will ‘receive the new treatment’, and contamination between groups is minimised.</em></p>
<p>Main issue: participants within the same group are often likely to be more similar to one another than to someone in a different group.</p>
<p>We expect that each group has its own ‘true’ mean <span class="math inline">\(\mu_k\)</span> , which is different from the underlying population mean <span class="math inline">\(\mu\)</span>, and that the cluster means are distributed with mean <span class="math inline">\(\mu\)</span> and variance <span class="math inline">\(\sigma^2_b\)</span> (more on <span class="math inline">\(\sigma^2_b\)</span> soon).</p>
<p>This violates one of the key assumptions we’ve held so far, that the data are independent, and leads us to a very important quantity called the <strong>intracluster correlation</strong> (ICC).</p>
<div id="intracluster-correlation" class="section level3 hasAnchor" number="9.1.1">
<h3><span class="header-section-number">9.1.1</span> Intracluster correlation<a href="cluster-rct.html#intracluster-correlation" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The ICC quantifies the relatedness of data that are clustered in groups by comparing the variance within groups by the variance between groups.</p>
<p><span class="math display">\[ICC = \frac{\sigma^2_b}{\sigma^2_b + \sigma^2_w}, \]</span>
where <span class="math inline">\(\sigma^2_b\)</span> is the variance <strong>between</strong> groups and <span class="math inline">\(\sigma^2_w\)</span> is the variance <strong>within</strong> groups.</p>
<ul>
<li><span class="math inline">\(\sigma_w^2=0\;\implies\;ICC=1\)</span> and all measurements within each group are the same. At the other extreme, where * <span class="math inline">\(\sigma^2_b=0\;\implies\;ICC=0\)</span> and all groups are independent and identically distributed.</li>
</ul>
<p>We can estimate <span class="math inline">\(\sigma_w^2\)</span> and <span class="math inline">\(\sigma_b^2\)</span> using <span class="math inline">\(s_w^2\)</span> and <span class="math inline">\(s_b^2\)</span>, which we find by decomposing the pooled variance.</p>
<p>Here, <span class="math inline">\(g\)</span> is the number of groups, <span class="math inline">\(n_j\)</span> is the number of participants in group <span class="math inline">\(j\)</span> and <span class="math inline">\(n\)</span> is the total number of participants.</p>
<p><span class="math display">\[
s^2_{Tot} =  \frac{\sum\limits_{j=1}^g \sum\limits_{i=1}^{n_j}\left(x_{ij}-\bar{x}\right)^2}{n-g}\\
\]</span>
We can split this up as</p>
<p><span class="math display">\[
\begin{aligned}
s^2_{Tot} &amp; = \frac{1}{n-g}\sum\limits_{j=1}^g \sum\limits_{i=1}^{n_j}\left(x_{ij} - \bar{x}_j + \bar{x}_j-\bar{x}\right)^2\\
&amp; = \frac{1}{n-g}\sum\limits_{j=1}^g \sum\limits_{i=1}^{n_j}\left[\left(x_{ij} - \bar{x}_j\right)^2 + \left(\bar{x}_j-\bar{x}\right)^2 + 2\left(x_{ij} - \bar{x}_j\right)\left(\bar{x}_j-\bar{x}\right)\right]\\
&amp; = \frac{1}{n-g}\sum\limits_{j=1}^g \sum\limits_{i=1}^{n_j}\left[\left(x_{ij} - \bar{x}_j\right)^2 + \left(\bar{x}_j-\bar{x}\right)^2 \right]\\
&amp;= \underbrace{\frac{1}{n-g}\sum\limits_{j=1}^g \sum\limits_{i=1}^{n_j}\left(x_{ij} - \bar{x}_j\right)^2}_{\text{Within groups}} + \underbrace{\frac{1}{n-g}\sum\limits_{j=1}^g n_j\left(\bar{x}_j - \bar{x}\right)^2}_{\text{Between groups}}
\end{aligned}
\]</span></p>
<div class="example">
<p><span id="exm:kroger" class="example"><strong>Example 9.1  </strong></span><em>We will demonstrate the ICC using a dataset that has nothing to do with clinical trials.</em></p>
<p>The <code>cheese</code> dataset contains the price per unit and volume of sales of cheese (who knows what kind) at many Kroger stores in the US.</p>
<p>We also know which city the Krogers are in, and we have data for 706 stores across 11 cities.</p>
<p><em>It might be reasonable to expect that if we have information about the price and sales volume for several stores within a particular city, this gives us more information about the price and volume for another store in that same city than for a store in another city.</em> Figure <a href="cluster-rct.html#fig:cheesedata">9.1</a> shows the price and volume for all stores, coloured by city.</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="cluster-rct.html#cb78-1" tabindex="-1"></a>cheese <span class="ot">=</span> <span class="fu">read.csv</span>(<span class="st">&quot;kroger.csv&quot;</span>, <span class="at">header=</span>T)</span>
<span id="cb78-2"><a href="cluster-rct.html#cb78-2" tabindex="-1"></a>cheese<span class="sc">$</span>city <span class="ot">=</span> <span class="fu">as.factor</span>(cheese<span class="sc">$</span>city)</span>
<span id="cb78-3"><a href="cluster-rct.html#cb78-3" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>cheese, <span class="fu">aes</span>(<span class="at">x=</span>price, <span class="at">y=</span>vol, <span class="at">col=</span>city)) <span class="sc">+</span> <span class="fu">geom_point</span>()</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:cheesedata"></span>
<img src="CT4H_lecture_notes_files/figure-html/cheesedata-1.png" alt="Price per unit and volume of sales of cheese for 706 Kroger stores." width="672" />
<p class="caption">
Figure 9.1: Price per unit and volume of sales of cheese for 706 Kroger stores.
</p>
</div>
<p>To calculate the ICC we define two functions, <code>between.var</code> and <code>within.var</code>, to calculate the between group and within group variance, as explained above.</p>
<details>
<summary>
Click to show R functions
</summary>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="cluster-rct.html#cb79-1" tabindex="-1"></a><span class="co"># Firstly we define functions for the estimates</span></span>
<span id="cb79-2"><a href="cluster-rct.html#cb79-2" tabindex="-1"></a>between.var <span class="ot">=</span> <span class="cf">function</span>(</span>
<span id="cb79-3"><a href="cluster-rct.html#cb79-3" tabindex="-1"></a>    data,</span>
<span id="cb79-4"><a href="cluster-rct.html#cb79-4" tabindex="-1"></a>    groupvec</span>
<span id="cb79-5"><a href="cluster-rct.html#cb79-5" tabindex="-1"></a>){</span>
<span id="cb79-6"><a href="cluster-rct.html#cb79-6" tabindex="-1"></a>  groups <span class="ot">=</span> <span class="fu">levels</span>(<span class="fu">as.factor</span>(groupvec))</span>
<span id="cb79-7"><a href="cluster-rct.html#cb79-7" tabindex="-1"></a>  ng <span class="ot">=</span> <span class="fu">length</span>(groups)</span>
<span id="cb79-8"><a href="cluster-rct.html#cb79-8" tabindex="-1"></a>  ntot <span class="ot">=</span> <span class="fu">length</span>(data)</span>
<span id="cb79-9"><a href="cluster-rct.html#cb79-9" tabindex="-1"></a>  </span>
<span id="cb79-10"><a href="cluster-rct.html#cb79-10" tabindex="-1"></a>  </span>
<span id="cb79-11"><a href="cluster-rct.html#cb79-11" tabindex="-1"></a>  means <span class="ot">=</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span>ng, <span class="cf">function</span>(i){<span class="fu">mean</span>(data[groupvec <span class="sc">==</span> groups[i]])})</span>
<span id="cb79-12"><a href="cluster-rct.html#cb79-12" tabindex="-1"></a>  njvec <span class="ot">=</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span>ng, <span class="cf">function</span>(i){<span class="fu">length</span>(data[groupvec <span class="sc">==</span> groups[i]])})</span>
<span id="cb79-13"><a href="cluster-rct.html#cb79-13" tabindex="-1"></a>  mean <span class="ot">=</span> <span class="fu">mean</span>(data)</span>
<span id="cb79-14"><a href="cluster-rct.html#cb79-14" tabindex="-1"></a>  ssqvec <span class="ot">=</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span>ng, <span class="cf">function</span>(i){(njvec[i]<span class="sc">*</span>(means[i]<span class="sc">-</span>mean)<span class="sc">^</span><span class="dv">2</span>)})</span>
<span id="cb79-15"><a href="cluster-rct.html#cb79-15" tabindex="-1"></a>  <span class="fu">sum</span>(ssqvec)<span class="sc">/</span>(ntot<span class="sc">-</span>ng)</span>
<span id="cb79-16"><a href="cluster-rct.html#cb79-16" tabindex="-1"></a>}</span>
<span id="cb79-17"><a href="cluster-rct.html#cb79-17" tabindex="-1"></a></span>
<span id="cb79-18"><a href="cluster-rct.html#cb79-18" tabindex="-1"></a>within.var <span class="ot">=</span> <span class="cf">function</span>(</span>
<span id="cb79-19"><a href="cluster-rct.html#cb79-19" tabindex="-1"></a>    data,</span>
<span id="cb79-20"><a href="cluster-rct.html#cb79-20" tabindex="-1"></a>    groupvec</span>
<span id="cb79-21"><a href="cluster-rct.html#cb79-21" tabindex="-1"></a>){</span>
<span id="cb79-22"><a href="cluster-rct.html#cb79-22" tabindex="-1"></a>  groups <span class="ot">=</span> <span class="fu">levels</span>(<span class="fu">as.factor</span>(groupvec))</span>
<span id="cb79-23"><a href="cluster-rct.html#cb79-23" tabindex="-1"></a>  ng <span class="ot">=</span> <span class="fu">length</span>(groups)</span>
<span id="cb79-24"><a href="cluster-rct.html#cb79-24" tabindex="-1"></a>  ntot <span class="ot">=</span> <span class="fu">length</span>(data)</span>
<span id="cb79-25"><a href="cluster-rct.html#cb79-25" tabindex="-1"></a>  </span>
<span id="cb79-26"><a href="cluster-rct.html#cb79-26" tabindex="-1"></a>  means <span class="ot">=</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span>ng, <span class="cf">function</span>(i){<span class="fu">mean</span>(data[groupvec <span class="sc">==</span> groups[i]])})</span>
<span id="cb79-27"><a href="cluster-rct.html#cb79-27" tabindex="-1"></a>  njvec <span class="ot">=</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span>ng, <span class="cf">function</span>(i){<span class="fu">length</span>(data[groupvec <span class="sc">==</span> groups[i]])})</span>
<span id="cb79-28"><a href="cluster-rct.html#cb79-28" tabindex="-1"></a></span>
<span id="cb79-29"><a href="cluster-rct.html#cb79-29" tabindex="-1"></a></span>
<span id="cb79-30"><a href="cluster-rct.html#cb79-30" tabindex="-1"></a>  g_sums <span class="ot">=</span> <span class="fu">rep</span>(<span class="cn">NA</span>, ng)</span>
<span id="cb79-31"><a href="cluster-rct.html#cb79-31" tabindex="-1"></a>  </span>
<span id="cb79-32"><a href="cluster-rct.html#cb79-32" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>ng){</span>
<span id="cb79-33"><a href="cluster-rct.html#cb79-33" tabindex="-1"></a>    data_j <span class="ot">=</span> data[groupvec <span class="sc">==</span> groups[j]]</span>
<span id="cb79-34"><a href="cluster-rct.html#cb79-34" tabindex="-1"></a>    ssqvec <span class="ot">=</span> <span class="fu">rep</span>(<span class="cn">NA</span>, njvec[j])</span>
<span id="cb79-35"><a href="cluster-rct.html#cb79-35" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>njvec[j]){</span>
<span id="cb79-36"><a href="cluster-rct.html#cb79-36" tabindex="-1"></a>      ssqvec[i] <span class="ot">=</span> (data_j[i] <span class="sc">-</span> means[j])<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb79-37"><a href="cluster-rct.html#cb79-37" tabindex="-1"></a>    }</span>
<span id="cb79-38"><a href="cluster-rct.html#cb79-38" tabindex="-1"></a>    g_sums[j] <span class="ot">=</span> <span class="fu">sum</span>(ssqvec)<span class="sc">/</span>(ntot <span class="sc">-</span> ng)</span>
<span id="cb79-39"><a href="cluster-rct.html#cb79-39" tabindex="-1"></a>  }</span>
<span id="cb79-40"><a href="cluster-rct.html#cb79-40" tabindex="-1"></a>  <span class="fu">sum</span>(g_sums)</span>
<span id="cb79-41"><a href="cluster-rct.html#cb79-41" tabindex="-1"></a>}</span>
<span id="cb79-42"><a href="cluster-rct.html#cb79-42" tabindex="-1"></a></span>
<span id="cb79-43"><a href="cluster-rct.html#cb79-43" tabindex="-1"></a><span class="do">## Now we can calculate them</span></span>
<span id="cb79-44"><a href="cluster-rct.html#cb79-44" tabindex="-1"></a></span>
<span id="cb79-45"><a href="cluster-rct.html#cb79-45" tabindex="-1"></a>bvar <span class="ot">=</span> <span class="fu">between.var</span>(iris<span class="sc">$</span>Sepal.Length, iris<span class="sc">$</span>Species)</span>
<span id="cb79-46"><a href="cluster-rct.html#cb79-46" tabindex="-1"></a>bvar</span></code></pre></div>
<pre><code>## [1] 0.4300145</code></pre>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="cluster-rct.html#cb81-1" tabindex="-1"></a>wvar <span class="ot">=</span> <span class="fu">within.var</span>(iris<span class="sc">$</span>Sepal.Length, iris<span class="sc">$</span>Species)</span>
<span id="cb81-2"><a href="cluster-rct.html#cb81-2" tabindex="-1"></a>wvar</span></code></pre></div>
<pre><code>## [1] 0.2650082</code></pre>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="cluster-rct.html#cb83-1" tabindex="-1"></a><span class="do">## And find the ICC:</span></span>
<span id="cb83-2"><a href="cluster-rct.html#cb83-2" tabindex="-1"></a></span>
<span id="cb83-3"><a href="cluster-rct.html#cb83-3" tabindex="-1"></a>icc <span class="ot">=</span> bvar<span class="sc">/</span>(bvar<span class="sc">+</span>wvar)</span>
<span id="cb83-4"><a href="cluster-rct.html#cb83-4" tabindex="-1"></a>icc</span></code></pre></div>
<pre><code>## [1] 0.6187057</code></pre>
</details>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="cluster-rct.html#cb85-1" tabindex="-1"></a>wv_price <span class="ot">=</span> <span class="fu">within.var</span>(cheese<span class="sc">$</span>price, cheese<span class="sc">$</span>city)</span>
<span id="cb85-2"><a href="cluster-rct.html#cb85-2" tabindex="-1"></a>bv_price <span class="ot">=</span> <span class="fu">between.var</span>(cheese<span class="sc">$</span>price, cheese<span class="sc">$</span>city)</span>
<span id="cb85-3"><a href="cluster-rct.html#cb85-3" tabindex="-1"></a>icc <span class="ot">=</span> bv_price <span class="sc">/</span> (bv_price <span class="sc">+</span> wv_price)</span>
<span id="cb85-4"><a href="cluster-rct.html#cb85-4" tabindex="-1"></a>icc</span></code></pre></div>
<pre><code>## [1] 0.253104</code></pre>
<p>We can see that for each city we know a fair amount about the cost of cheese. But, if we had to predict the price of cheese in a new city, for which we have no data, we would have no idea what the mean for that city would be, apart from that it would come from <span class="math inline">\(N\left(\mu,\;\sigma^2_b\right)\)</span>, where <span class="math inline">\(\mu\)</span> is the mean price of cheese in the overall population and <span class="math inline">\(\sigma^2_b\)</span> is the between group variance.</p>
</div>
<p><em>Estimating the ICC when planning a study is an important step, but isn’t always easy.</em></p>
<p><em>Sometimes estimated from existing data, which is likely to cover many sites.</em></p>
<p><em>In non-medical studies like education or social interventions (where cluster RCTs are very common), it can be much more difficult because there is generally less data.</em></p>
<p><em>Statistical studies are much newer in these areas, though they are becoming increasingly common, and even mandated by some organisations (for example the <a href="https://educationendowmentfoundation.org.uk">Educational Endowment Foundation</a>).</em></p>
</div>
</div>
<div id="sample-size" class="section level2 hasAnchor" number="9.2">
<h2><span class="header-section-number">9.2</span> Sample size<a href="cluster-rct.html#sample-size" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The upshot of the non-independence of the sample is that we have less information from <span class="math inline">\(n\)</span> participants in a cluster RCT than we would do for an individual-based RCT <em>where all the participants were independent (at least conditional on some covariates).</em></p>
<p>At extremes:</p>
<ul>
<li>ICC=0: same as a normal RCT.</li>
<li>ICC=1, all measurements within a cluster are identical, and to achieve the same power as with <span class="math inline">\(n\)</span> particpants in a standard RCT, we would need <span class="math inline">\(n\)</span> clusters (and their size would be irrelevant).</li>
</ul>
<p><em>Obviously neither of these is ever true! In most studies, the ICC is in <span class="math inline">\(\left(0,\;0.15\right)\)</span>.</em></p>
<p>We will work through the sample size (and indeed most other things) for a cluster RCT in which the outcome is continuous (as in Chapter <a href="rct-plan.html#rct-plan">2</a>), but you can equally do a cluster RCT with a binary or time-to-event outcome.</p>
<p>The first step is to think about how the clustering affects the variance. An estimate of the outcome variance in the control group, ignoring the clustering, is</p>
<p><span class="math display" id="eq:varcrt1">\[\begin{equation}
\hat{\sigma}^2 = \frac{\sum\limits_{j=1}^g\sum\limits_{i=1}^{n_j}\left(X_{ij} - \bar{X}\right)^2}{n-1},
\tag{9.1}
\end{equation}\]</span></p>
<p>where as before there are <span class="math inline">\(g\)</span> clusters, cluster <span class="math inline">\(j\)</span> has size <span class="math inline">\(n_j\)</span> and <span class="math inline">\(\sum\limits_{j=1}^gn_j=n\)</span> is the total sample size.</p>
<p>The mean is also calculated without reference to the clustering, so</p>
<p><span class="math display">\[\bar{X} =  \frac{\sum\limits_{j=1}^g\sum\limits_{i=1}^{n_j}X_{ij}}{n}.\]</span></p>
<p>It can be shown that the variance of the overall mean in either group is inflated by a factor of</p>
<p><span class="math display">\[1 + \rho\left[ \frac{\sum\limits_j n_j^2}{N} - 1 \right]. \]</span></p>
<p>This quantity is known as the <strong>design effect</strong>. Notice that if all the groups are the same size <span class="math inline">\(n_g = \frac{n}{g}\)</span> then the design effect simplifies to</p>
<p><span class="math display">\[1 + \rho\left(n_g - 1\right).\]</span>
We will assume from now on that this is the case.</p>
<div id="ss-crt" class="section level4 hasAnchor" number="9.2.0.1">
<h4><span class="header-section-number">9.2.0.1</span> A formula for sample size<a href="cluster-rct.html#ss-crt" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Now that we know <span class="math inline">\(\operatorname{E}\left(\hat{\sigma}^2\right)\)</span> we can adapt our sample size formula from Section <a href="lecture-3.html#sec-ssformulacont">2.5</a>. For an individual-level RCT with a continuous outcome, we had</p>
<p><span class="math display" id="eq:ss1">\[\begin{equation}
n = \frac{2\sigma^2\left(z_{\beta} + z_{\alpha/2}\right)^2}{\tau^2_M},
\tag{9.2}
\end{equation}\]</span></p>
<p>and the reason we were able to do this was because the variance of the treatment effect estimate was <span class="math inline">\(\sigma^2/n\)</span>.
For a cluster RCT, the variance of the treatment effect is</p>
<p><span class="math display" id="eq:varte1">\[\begin{equation}
\frac{\sigma^2}{n} \left[1 + \rho\left(\frac{\sum\limits_{j=1}^g n_j}{n}-1\right)\right]
\tag{9.3}
\end{equation}\]</span></p>
<p>At the planning stage of a cluster RCT we are unlikely to know the size of each cluster, so usually specify a [conservative] average cluster size <span class="math inline">\(n_g\)</span>.</p>
<p><em>each individual involved will usually need to give their consent, so knowing the size of the hospital / GP surgery / class is not enough.</em></p>
<p>In this case, the variance of the treatment effect in Equation <a href="cluster-rct.html#eq:varte1">(9.3)</a> becomes</p>
<p><span class="math display" id="eq:varte2">\[\begin{equation}
\frac{\sigma^2}{n} \left[1 + \rho\left(n_g-1\right)\right] .
\tag{9.4}
\end{equation}\]</span></p>
<p>Equation <a href="cluster-rct.html#eq:varte2">(9.4)</a> can be combined with Equation <a href="cluster-rct.html#eq:ss1">(9.2)</a> to give the sample size formula for a cluster RCT:</p>
<p><span class="math display">\[n = \frac{2\sigma^2\left[1 + \rho\left(n_g-1\right)\right]\left(z_{\beta} + z_{\alpha/2}\right)^2}{\tau^2_M}.
\]</span>
Since <span class="math inline">\(n=n_gg\)</span>, this can be rearranged to find the number of clusters of a given size needed, or the size of cluster if a given number of clusters is to be used.</p>
<p><em>The sample size (and therefore the real power of the study) depends on two additional quantities that are generally beyond our control, and possibly knowledge: ICC and <span class="math inline">\(n_g\)</span>. It is therefore sensible to conduct some sensitivity analysis, with several scenarios of ICC and <span class="math inline">\(n_g\)</span>, to see what the implications are for the power of the study if things don’t quite go to plan.</em></p>
<div class="example">
<p><span id="exm:unlabeled-div-42" class="example"><strong>Example 9.2  </strong></span>This is something I wrote for an education study I’m involved in (funded by the EEF) where the treatment is a particular way of engaging 2 year olds in conversation. The outcome variable is each child’s score on the British Picture Vocabulary Scale (BPVS), a test aimed at 3 - 16 year olds designed to assess each child’s vocabulary. We needed to recruit some number of nurseries, but had very little information about the IIC (notice that the age in our study is outside the intended range of the BPVS test!).</p>
<p>To help the rest of the evaluation team understand the sensitivity of the power of the study to various quantities, I designed <a href="https://racheloughton.shinyapps.io/sample_size/">this dashboard</a>, so that they could play around with the variables and see the effect.</p>
<p>As well as giving the sample size for a simple t-test (as we’ve done above) it also shows the size for a random effects model (similar to ANCOVA, more on this soon), which is why the baseline-outcome correlation (about which we also know very little!) is included.</p>
<p>The plot shows the minimum detectable effect size (MDES, or <span class="math inline">\(\tau_M\)</span>, in SD units), since the evaluation team wanted to know what size of effect we could find with our desired power.</p>
</div>
</div>
</div>
<div id="allocation" class="section level2 hasAnchor" number="9.3">
<h2><span class="header-section-number">9.3</span> Allocation<a href="cluster-rct.html#allocation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In a cluster RCT, everyone within a particular cluster will be in the same group (<span class="math inline">\(T\)</span> or <span class="math inline">\(C\)</span>). Therefore, the allocation needs to be performed at the cluster level, rather than at the individual level <em>as we did in Chapter <a href="#alloc"><strong>??</strong></a>.</em></p>
<p><em>In theory we could use any of the first few methods we learned (simple random sampling, random permuted blocks, biased coin, urn design) to allocate the clusters. However, there are often relatively few clusters, and so the potential for imbalance in terms of the nature of the clusters would be rather high. This means we are more likely to use a stratified method or minimisation.</em></p>
<p>In terms of prognostic factors, there are now two levels: cluster level and individual level.</p>
<p>Eg, with GP practices as clusters:</p>
<ul>
<li>cluster-level covariates: size of the practice, rural or urban, the IMB (index of mass deprivation) … <em>It would be sensible to make sure there was balance in each of these in the allocation.</em></li>
<li>Could include aggregates of individual-level characteristics: mean age, or proportion of people with a particular condition, … <em>(especially if the study relates to a particular condition).</em></li>
</ul>
<p>However, a key feature of cluster RCTs means that in fact some different, and perhaps more effective, allocation methods are open to us.</p>
<div id="allocating-everyone-at-once" class="section level3 hasAnchor" number="9.3.1">
<h3><span class="header-section-number">9.3.1</span> Allocating everyone at once<a href="cluster-rct.html#allocating-everyone-at-once" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The methods we’ve covered so far assume that participants are recruited sequentially, and begin the intervention at different points in time. When allocating participant <span class="math inline">\(n\)</span>, we only know the allocation for participants <span class="math inline">\(1,\ldots,n-1\)</span>.</p>
<p><em>It is very likely that we don’t know the details of the following participants, in particular their values of any prognostic variables. This makes sense in many medical settings, where a patient would want to begin treatment as soon as possible, and there may be a limited number of patients with particular criteria at any one time.</em></p>
<p>However, cluster RCTs rarely deal with urgent conditions (at least in the sense of administering a direct treatment), and so the procedure is usually that the settings (the clusters) are recruited over some recruitment period and all begin the intervention at the same time.</p>
<p>This means that at the point of allocation, the details of all settings involved are known.
There are a couple of proposals for how to deal with allocation in this scenario, and we will look at one now.</p>
</div>
<div id="covariate-constrained-randomization" class="section level3 hasAnchor" number="9.3.2">
<h3><span class="header-section-number">9.3.2</span> Covariate constrained randomization<a href="cluster-rct.html#covariate-constrained-randomization" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>This method is proposed in <span class="citation">(<a href="#ref-dickinson2015pragmatic"><strong>dickinson2015pragmatic?</strong></a>)</span>, and implemented in the R package <code>cvcrand</code>.
<em>We’ll review the key points of the method, but if you’re interested you can find the details in the article.</em></p>
<p><em>Baseline information must be available for all settings, for any covariate thought to be potentially important. These can be setting-level variables or aggregates of individual-level variables. Once all this data has been collected, the randomisation procedure is as follows.</em></p>
<p>Allocation procedure:</p>
<ol style="list-style-type: decimal">
<li>Generate all possible allocations of the clusters into two arms (<span class="math inline">\(T\)</span> and <span class="math inline">\(C\)</span>).</li>
<li>Rule out all allocations that don’t achieve the desired balance criteria to leave <strong>optimal set</strong>.</li>
<li>Choose one allocation at random from the optimal set</li>
</ol>
<p>Balance criteria:</p>
<ul>
<li>Factor covariates: eg. want groups C and T to have same number (or close) of rural GP practices</li>
<li>Continuous covariates: standardised (to mean 0, SD 1) and used to calculate a ‘Balance score’</li>
</ul>
</div>
</div>
<div id="analysing-a-cluster-rct" class="section level2 hasAnchor" number="9.4">
<h2><span class="header-section-number">9.4</span> Analysing a cluster RCT<a href="cluster-rct.html#analysing-a-cluster-rct" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><em>As with the other stages of a cluster RCT, to conduct an effective and accurate analysis we need to take into account the clustered nature of the data. There are several ways to do this, and we will whizz through the main ones now.</em></p>
<div class="example">
<p><span id="exm:unlabeled-div-43" class="example"><strong>Example 9.3  </strong></span>Data from an educational trial, contained in <code>crtData</code> in the package <code>eefAnalytics</code>, shown in Figure <a href="cluster-rct.html#fig:crtboxplots">9.2</a> . The dataset contains 22 schools and 265 pupils in total. Each school was assigned to either <code>1</code> (group <span class="math inline">\(T\)</span>) or <code>0</code> (group <span class="math inline">\(C\)</span>). Each pupil took a test before the trial, and again at the end of the trial.
We also know the percentage attendance for each pupil. We will use this data to demonstrate each method.</p>
<pre><code>## &#39;data.frame&#39;:    265 obs. of  4 variables:
##  $ School      : Factor w/ 22 levels &quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,..: 1 1 1 1 1 1 1 1 1 1 ...
##  $ Posttest    : num  16 13 18 14 25 13 23 26 16 8 ...
##  $ Intervention: Factor w/ 2 levels &quot;0&quot;,&quot;1&quot;: 2 2 2 2 2 2 2 2 2 2 ...
##  $ Prettest    : num  1 4 5 4 5 2 5 5 2 2 ...</code></pre>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="cluster-rct.html#cb88-1" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data=</span>crt_df, <span class="fu">aes</span>(<span class="at">y=</span>Posttest, <span class="at">fill=</span>Intervention, <span class="at">group =</span> School)) <span class="sc">+</span> <span class="fu">geom_boxplot</span>()</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:crtboxplots"></span>
<img src="CT4H_lecture_notes_files/figure-html/crtboxplots-1.png" alt="Box plots of the outcome Posttest for each school, coloured by Intervention." width="672" />
<p class="caption">
Figure 9.2: Box plots of the outcome Posttest for each school, coloured by Intervention.
</p>
</div>
</div>
<div id="at-the-cluster-level" class="section level3 hasAnchor" number="9.4.1">
<h3><span class="header-section-number">9.4.1</span> At the cluster level<a href="cluster-rct.html#at-the-cluster-level" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Idea: aggregate data to the cluster level, so that for each cluster (school, in our example), there is effectively one data point.</p>
<p>Advantages:</p>
<ul>
<li>Fast</li>
<li>Simple methodology (eg. t-test)</li>
</ul>
<p>Disadvantages:</p>
<ul>
<li>Loses a lot of information</li>
<li>Not appropriate if group sizes vary (the larger group <span class="math inline">\(j\)</span>, the smaller the SE of <span class="math inline">\(\bar{x}_j\)</span>)</li>
</ul>
<p><em>There are methods designed to account for this, such as the weighted t-test, but these methods are generally inefficient and less robust. These methods are generally thought to be appropriate for fewer than 15-20 clusters per treatment arm.</em></p>
<p><em>One possibility for our trial would be to collect the mean and SD of scores within each school, and perform a t-test to find out if there is a significant difference between the intervention and control arms.</em></p>
<p><em>If we wanted to find out whether this depended on, say, gender, we could split the data set and perform seperate t-tests for the different gender groups.</em></p>
<p><em>This has the advantage that it is simple to implement, but the disadvantage that it is difficult to take into account covariates (apart from in the simple way discussed for eg. gender). With a small study, it is likely that there is some imbalance in the design in terms of covariates.</em></p>
<p>The required sample size for this option would be</p>
<p><span class="math display">\[
g = \frac{2 \sigma^2 \left[1+ \left(n_g-1\right)\rho_{icc}\right]}{n_g\tau^2_M}\left(z_{\beta} + z_{\frac{1}{2}\alpha}\right)^2,
\]</span>
where <span class="math inline">\(n_g\)</span> is the average cluster size and <span class="math inline">\(g\)</span> is the number of clusters per treatment arm. This is the value we worked out in Section <a href="cluster-rct.html#ss-crt">9.2.0.1</a></p>
<div class="example">
<p><span id="exm:unlabeled-div-44" class="example"><strong>Example 9.4  </strong></span>We can perform this analysis on our schools data. The first step is to calculate the difference between <code>Posttest</code> and <code>Pretest</code> for each pupil (we could also use just <code>Posttest</code>).</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="cluster-rct.html#cb89-1" tabindex="-1"></a>crt_df<span class="sc">$</span>diff <span class="ot">=</span> crt_df<span class="sc">$</span>Posttest <span class="sc">-</span> crt_df<span class="sc">$</span>Prettest</span></code></pre></div>
<p>We can then aggregate this to find the mean of <code>diff</code> for each school, shown in Table <a href="cluster-rct.html#tab:eefsum">9.1</a>:</p>
<table>
<caption><span id="tab:eefsum">Table 9.1: </span>EEF data with difference calculated (first 10 rows).</caption>
<thead>
<tr class="header">
<th align="left">School</th>
<th align="right">MeanDiff</th>
<th align="right">ng</th>
<th align="left">Group</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">1</td>
<td align="right">13.76923</td>
<td align="right">13</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="right">19.09091</td>
<td align="right">33</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">3</td>
<td align="right">20.43333</td>
<td align="right">30</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">4</td>
<td align="right">19.00000</td>
<td align="right">30</td>
<td align="left">0</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="right">16.66667</td>
<td align="right">15</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">6</td>
<td align="right">14.40000</td>
<td align="right">5</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">7</td>
<td align="right">16.75000</td>
<td align="right">24</td>
<td align="left">1</td>
</tr>
<tr class="even">
<td align="left">8</td>
<td align="right">13.83333</td>
<td align="right">12</td>
<td align="left">0</td>
</tr>
<tr class="odd">
<td align="left">9</td>
<td align="right">15.00000</td>
<td align="right">4</td>
<td align="left">0</td>
</tr>
<tr class="even">
<td align="left">10</td>
<td align="right">18.28571</td>
<td align="right">14</td>
<td align="left">1</td>
</tr>
</tbody>
</table>
<p>We can also visualise the mean differences by group</p>
<div class="figure"><span style="display:block;" id="fig:crt1bp"></span>
<img src="CT4H_lecture_notes_files/figure-html/crt1bp-1.png" alt="Boxplots of the mean differences for each trial arm" width="672" />
<p class="caption">
Figure 9.3: Boxplots of the mean differences for each trial arm
</p>
</div>
<p>From Figure <a href="cluster-rct.html#fig:crt1bp">9.3</a> it certainly looks likely that a significant difference will be found.</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="cluster-rct.html#cb90-1" tabindex="-1"></a><span class="fu">t.test</span>(</span>
<span id="cb90-2"><a href="cluster-rct.html#cb90-2" tabindex="-1"></a>  <span class="at">x=</span>crt_summ<span class="sc">$</span>MeanDiff[crt_summ<span class="sc">$</span>Group<span class="sc">==</span><span class="dv">0</span>],</span>
<span id="cb90-3"><a href="cluster-rct.html#cb90-3" tabindex="-1"></a>  <span class="at">y=</span>crt_summ<span class="sc">$</span>MeanDiff[crt_summ<span class="sc">$</span>Group<span class="sc">==</span><span class="dv">1</span>],</span>
<span id="cb90-4"><a href="cluster-rct.html#cb90-4" tabindex="-1"></a>  <span class="at">alternative =</span> <span class="st">&quot;two.sided&quot;</span>,</span>
<span id="cb90-5"><a href="cluster-rct.html#cb90-5" tabindex="-1"></a>  <span class="at">paired =</span> F,</span>
<span id="cb90-6"><a href="cluster-rct.html#cb90-6" tabindex="-1"></a>  <span class="at">var.equal=</span>F</span>
<span id="cb90-7"><a href="cluster-rct.html#cb90-7" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## 
##  Welch Two Sample t-test
## 
## data:  crt_summ$MeanDiff[crt_summ$Group == 0] and crt_summ$MeanDiff[crt_summ$Group == 1]
## t = -2.2671, df = 19.983, p-value = 0.03463
## alternative hypothesis: true difference in means is not equal to 0
## 95 percent confidence interval:
##  -6.4133879 -0.2667059
## sample estimates:
## mean of x mean of y 
##  13.72454  17.06459</code></pre>
</div>
<p><em>This is fairly easy to implement, but it seems rather unsatisfactory. It’s also probably not entirely appropriate because the group sizes vary from one (!) to 33. What we need is a linear (in the continuous outcome case at least) model that takes into account the covariates, and makes the most of the available data.</em></p>
</div>
<div id="at-the-individual-level-mixed-effects-models" class="section level3 hasAnchor" number="9.4.2">
<h3><span class="header-section-number">9.4.2</span> At the individual level: mixed effects models<a href="cluster-rct.html#at-the-individual-level-mixed-effects-models" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><strong>Mixed effects model</strong> or <strong>random effects model</strong>, or <strong>multilevel models</strong>.</p>
<p>§used when it cannot be assumed that the outputs are all independent of one another.</p>
<p><em>In the cluster randomized trial setting, this is because outcomes for participants within the same cluster can be expected to be more highly correlated than outcomes for patients from different clusters, but we will see examples of other designs in the next lecture.</em></p>
<p>To understand mixed effects models, we need to think about the difference between <strong>fixed effects</strong> and <strong>random effects</strong>. These are two different types of factor variables.</p>
<div id="fixed-effects" class="section level4 unnumbered hasAnchor">
<h4>Fixed effects<a href="cluster-rct.html#fixed-effects" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>These are the sorts of factor variables we’re used to dealing with in linear models:</p>
<ul>
<li>we don’t assume any relationship between the levels</li>
<li>we are generally interested in comparing the groups or categories represented by the fixed effect factors.</li>
</ul>
<p><em>We’ve seen these throughout the course, most notably with the treatment group variable <span class="math inline">\(G_i\)</span>, but also with things like smoking history, sex, disease details.</em></p>
<p><em>When conducting a clinical trial, we’re likely to try to include participants with all levels of the fixed effects we’re interested in, so that we can make inferences about the effect of the different levels of those effects.</em></p>
</div>
<div id="random-effects" class="section level4 unnumbered hasAnchor">
<h4>Random effects<a href="cluster-rct.html#random-effects" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p><em>Random effects are probably just as common in real life, but we haven’t seen them yet.</em></p>
<p>Factor variables that we think of as being drawn from some underlying model or distribution. For example, this could be GP surgery or school class, or an individual.</p>
<p>We expect each GP surgery / school class / individual to behave slightly differently (depending on the extent of the intracluster correlation) but to behave as though from some overall distribution.</p>
<p><em>Unlike fixed effects, random effects are generally things we aren’t specifically interested in understanding the effect of, but we want to account for the variation they bring.</em></p>
<p><em>We’re also unable to include all levels of the random effect in our study - for example, a study looking at the effect of an intervention in schools will involve perhaps 50 schools, but we want to apply to results to all schools in the UK (say).</em></p>
<p>We therefore assume that the schools are drawn from some normal distribution (in terms of the outcome we’re interested in), and that therefore all the schools we haven’t included also belong to this distribution.</p>
<p>In Example <a href="cluster-rct.html#exm:kroger">9.1</a> we aren’t trying to compare different cities, and we certainly don’t have data for Kroger stores in all cities, but we’re assuming that the mean cheese price <span class="math inline">\(\mu_{\text{city}_i}\)</span> in the different cities is drawn from <span class="math inline">\(N\left(\mu,\,\sigma^2_B\right)\)</span>, and that within each city the cheese price is drawn from <span class="math inline">\(N\left(\mu_{\text{city}_i},\;\sigma^2_W\right)\)</span>.</p>
<p><em>Including random effects allows us to account for the fact that some schools might be in general a bit better / worse performing, or some individuals might be a bit more / less healthy, because of natural variation. We will see more examples of the use of random effects in the next lecture.</em></p>
</div>
<div id="the-mixed-effects-model" class="section level4 unnumbered hasAnchor">
<h4>The mixed effects model<a href="cluster-rct.html#the-mixed-effects-model" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Mixed effects models allow us to combine fixed effects and random effects.</p>
<p><em>We’ll look at them next lecture too, because they are useful for many more situations than cluster RCTs, but this is as good a place as any to start!</em></p>
<p><span class="math display" id="eq:remodel">\[\begin{equation}
x_{ijk} = \alpha + \beta G_i + \sum\limits_l \gamma_l z_{ijkl} + u_{ij} + v_{ijk}
\tag{9.5}
\end{equation}\]</span></p>
<p>where</p>
<ul>
<li><span class="math inline">\(x_{ijk}\)</span> is the outcome for the <span class="math inline">\(k\)</span>-th individual in the <span class="math inline">\(j\)</span>-th cluster in the <span class="math inline">\(i\)</span>-th treatment arm (usually <span class="math inline">\(i=0\)</span> is the control arm and <span class="math inline">\(i=1\)</span> is the intervention arm)</li>
<li><span class="math inline">\(\alpha\)</span> is the intercept of the model</li>
<li><span class="math inline">\(\beta\)</span> is the intervention effect, and <span class="math inline">\(G_i\)</span> the group indicator variable (0 for group <span class="math inline">\(C\)</span>, 1 for group <span class="math inline">\(T\)</span>). Our null hypothesis is that <span class="math inline">\(\beta\)</span> is also zero)</li>
<li>The <span class="math inline">\(z_{ijkl}\)</span> are <span class="math inline">\(L\)</span> different individual level covariates that we wish to take into account, and the <span class="math inline">\(\gamma_l\)</span> are the estimated coefficients.</li>
<li><span class="math inline">\(u_{ij}\)</span> is a random effect relating to the <span class="math inline">\(j\)</span>-th cluster in the <span class="math inline">\(i\)</span>-th treatment arm. This is the term that accounts for the between-cluster variation. We assume <span class="math inline">\(u_{ij}\)</span> is normally distributed with mean 0 and variance <span class="math inline">\(\sigma^2_B\)</span> (the between-cluster variance).</li>
<li><span class="math inline">\(v_{ijk}\)</span> is a random effect relating to the <span class="math inline">\(k\)</span>-th individual in the cluster (ie. an individual level random error term), assumed normally distributed with mean 0 and variance <span class="math inline">\(\sigma^2_W\)</span> (the within-cluster variance).</li>
</ul>
<p><em>The part of the model that makes this particularly suitable to a cluster randomized trial is <span class="math inline">\(u_{ij}\)</span>. Notice that this has no <span class="math inline">\(k\)</span> index, and is therefore the same for all participants within a particular cluster.</em></p>
<p><em>With a random effects model we can take into account the effects of individual-level covariates and also the clustered design of the data.</em></p>
<p>Approximately, our sample size requirements are</p>
<p><span class="math display">\[
k = \frac{2 \sigma^2 \left[1+ \left(m-1\right)\rho_{icc}\right]\left(1-\rho^2\right) }{m\tau^2_M}\left(z_{\beta} + z_{\frac{1}{2}\alpha}\right)^2.
\]</span></p>
<p><em>Broadly this follows on from the logic we used to show the reduction in variance from the ANCOVA model in Section <a href="rct-analysis.html#ancova-var">4.3.1.2</a>, and you’ll notice that the factor of <span class="math inline">\(1-\rho^2\)</span> is the same. The details for cluster randomized trials are given in <span class="citation">(<a href="#ref-teerenstra2012simple"><strong>teerenstra2012simple?</strong></a>)</span>.</em></p>
<p>This is the ‘Random effects model’ line in <a href="https://racheloughton.shinyapps.io/sample_size/?_ga=2.190583720.2013007057.1679308387-1261352122.1678702192">the shiny dashboard</a>.)</p>
<p><em>The random effects model is more suitable when there are more than around 15-20 clusters in each arm.</em></p>
<div class="example">
<p><span id="exm:unlabeled-div-45" class="example"><strong>Example 9.5  </strong></span>We’ll now fit a random effects model to the <code>crtData</code> dataset from <code>eefAnalytics</code>. A good starting point is to plot the data with this in mind, to see what we might expect.</p>
<div class="figure"><span style="display:block;" id="fig:eefplot2"></span>
<img src="CT4H_lecture_notes_files/figure-html/eefplot2-1.png" alt="Posttest against Prettest, coloured by Intervention" width="672" />
<p class="caption">
Figure 9.4: Posttest against Prettest, coloured by Intervention
</p>
</div>
<p>From Figure <a href="cluster-rct.html#fig:eefplot2">9.4</a> it appears there might be a positive relationship between <code>Prettest</code> and <code>Posttest</code>, and also that the <code>Posttest</code> scores might be higher in the intervention group.</p>
<p>We’ll do this using the R package <code>lme4</code>. The function to specify a linear mixed effects model is called <code>lmer</code>, and works very similarly to <code>lm</code>. The term <code>(1|School)</code> tells R that the variable <code>School</code> should be treated as a random effect, not a fixed effect.</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="cluster-rct.html#cb92-1" tabindex="-1"></a><span class="fu">library</span>(lme4) </span>
<span id="cb92-2"><a href="cluster-rct.html#cb92-2" tabindex="-1"></a><span class="fu">library</span>(sjPlot)</span>
<span id="cb92-3"><a href="cluster-rct.html#cb92-3" tabindex="-1"></a>lmer_eef1 <span class="ot">=</span> <span class="fu">lmer</span>(Posttest <span class="sc">~</span> Prettest <span class="sc">+</span> Intervention <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>School), <span class="at">data=</span>crt_df )</span></code></pre></div>
<p>The package <code>sjPlot</code> contains functions to work with mixed effect model objects, for example <code>plot_model</code></p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="cluster-rct.html#cb93-1" tabindex="-1"></a>sjPlot<span class="sc">::</span><span class="fu">plot_model</span>(lmer_eef1)</span></code></pre></div>
<div class="figure"><span style="display:block;" id="fig:lmerplot1"></span>
<img src="CT4H_lecture_notes_files/figure-html/lmerplot1-1.png" alt="CIs for the model coefficients for the mixed effects model of crtData." width="672" />
<p class="caption">
Figure 9.5: CIs for the model coefficients for the mixed effects model of crtData.
</p>
</div>
<p>and <code>tab_model</code></p>
<table style="border-collapse:collapse; border:none;">
<tr>
<th style="border-top: double; text-align:center; font-style:normal; font-weight:bold; padding:0.2cm;  text-align:left; ">
 
</th>
<th colspan="3" style="border-top: double; text-align:center; font-style:normal; font-weight:bold; padding:0.2cm; ">
Posttest
</th>
</tr>
<tr>
<td style=" text-align:center; border-bottom:1px solid; font-style:italic; font-weight:normal;  text-align:left; ">
Predictors
</td>
<td style=" text-align:center; border-bottom:1px solid; font-style:italic; font-weight:normal;  ">
Estimates
</td>
<td style=" text-align:center; border-bottom:1px solid; font-style:italic; font-weight:normal;  ">
CI
</td>
<td style=" text-align:center; border-bottom:1px solid; font-style:italic; font-weight:normal;  ">
p
</td>
</tr>
<tr>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; ">
(Intercept)
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
11.23
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
9.01 – 13.44
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
<strong>&lt;0.001</strong>
</td>
</tr>
<tr>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; ">
Prettest
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
1.79
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
1.39 – 2.18
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
<strong>&lt;0.001</strong>
</td>
</tr>
<tr>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; ">
Intervention [1]
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
3.11
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
0.73 – 5.49
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
<strong>0.011</strong>
</td>
</tr>
<tr>
<td colspan="4" style="font-weight:bold; text-align:left; padding-top:.8em;">
Random Effects
</td>
</tr>
<tr>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; padding-top:0.1cm; padding-bottom:0.1cm;">
σ<sup>2</sup>
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;" colspan="3">
14.78
</td>
</tr>
<tr>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; padding-top:0.1cm; padding-bottom:0.1cm;">
τ<sub>00</sub> <sub>School</sub>
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;" colspan="3">
5.67
</td>
<tr>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; padding-top:0.1cm; padding-bottom:0.1cm;">
ICC
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;" colspan="3">
0.28
</td>
<tr>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; padding-top:0.1cm; padding-bottom:0.1cm;">
N <sub>School</sub>
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;" colspan="3">
22
</td>
<tr>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; padding-top:0.1cm; padding-bottom:0.1cm; border-top:1px solid;">
Observations
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left; border-top:1px solid;" colspan="3">
265
</td>
</tr>
<tr>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; padding-top:0.1cm; padding-bottom:0.1cm;">
Marginal R<sup>2</sup> / Conditional R<sup>2</sup>
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;" colspan="3">
0.256 / 0.462
</td>
</tr>
</table>
<p>Perhaps unsurprisingly, the coefficient of the baseline test score is very significant, and the intervention also has a significant effect. This function also estimates the intracluster correlation, which we see is 0.28.</p>
<p>:::</p>
<p>There are various different ways we can include random effects in the model, as shown in Figure <a href="cluster-rct.html#fig:raneffmodels">9.6</a>. In our EEF data example we have used a fixed slope and fixed intercept.</p>
<div class="figure"><span style="display:block;" id="fig:raneffmodels"></span>
<img src="images/raneffmodels.png" alt="Different ways of including random effects in a mixed effects model."  />
<p class="caption">
Figure 9.6: Different ways of including random effects in a mixed effects model.
</p>
</div>
<p>The mixed effects model can be extended to a <strong>generalized mixed effects model</strong>, which is akin to a generalized linear model. For example, with a binary outcome <span class="math inline">\(X_{ijk}\)</span> we can adopt the model</p>
<p><span class="math display">\[
\operatorname{logit}\left(\pi_{ijk}\right) = \alpha + \beta G_i + \sum\limits_l \gamma_l z_{ijkl} + u_{ij} + v_{ijk}.
\]</span></p>
<p>We will look in the next lecture at some more trial designs for which mixed effects models are useful.</p>

            </section>

          </div>
        </div>
      </div>
<a href="lecture-16-comparing-survival-curves.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="references.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["CT4H_lecture_notes.pdf"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
