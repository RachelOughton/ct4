hamps_comp_df[,c(5,23:25)] %>% kable() %>% kable_styling("striped") %>%
scroll_box(height = "600px")
hamps_df = rbind(hamps_int_df, hamps_comp_df)
dim(hamps_df)
any(is.na(hamps_df$victim_ID))
?glm.convert
?glm
vis_dat(hamps_df)
psm_hamps1 = glm(
FM_equip ~ suspect_age + CoC  + nprev_sus + risk_ass + CoC_susprev + violent_SO_susprev,
data = hamps_df,
family = binomial(link="logit"))
tbl_regression(psm_hamps1)
summary(psm_hamps1)
hamps_po = predict(
object = psm_hamps1,
newdata = hamps_df,
type = "response"
)
hamps_df$propensity_score = hamps_po
vis_dat(hamps_df)
table(hamps_comp_df$risk_ass)
psm_hamps3 = glm(
FM_equip ~ CoC  + nprev_sus + risk_ass + CoC_susprev,
data = hamps_df,
family = binomial(link="logit"))
tbl_regression(psm_hamps3)
hamps_po3 = predict(
object = psm_hamps3,
newdata = hamps_df,
type = "response"
)
hamps_df$propensity_score3 = hamps_po3
dim(hamps_df)
vis_dat(hamps_df)
hamps_cutoff_0_015 = hamps_df[hamps_df$propensity_score3>0.015,]
dim(hamps_cutoff_0_015)
hamps_cutoff_0_015$victim_ID
hamps_df$victim_ID
hamps_df$victim_ID[is.na(hamps_df$propensity_score3)]
hamps_cutoff_0_015 = hamps_df[(hamps_df$propensity_score3>0.015)&(!is.na(hamps_df$propensity_score3)),]
hamps_cutoff_0_015$victim_ID
write_excel_csv(hamps_cutoff_0_015, file = "Hampshire/PSM_comparisongroup_30Jan.csv", quote=NULL)
462/52
438/50
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(ggplot2)
library(gridExtra)
library(kableExtra)
library(readr)
library(readxl)
library(tidyverse)
library(visdat)
library(reshape2)
library(gtsummary)
require(utf8)
# setwd("/Users/rachelo/OneDrive - Durham University/AP2020_21/Projects/CoP/SmartWater/FM_analysis/")
# hamps_int = read.csv("Hampshire/Anonymised- Op Sentry - Stage 1 Hampshire Complete RE(REVISEDproject management data).csv", header=T)
hamps_int = read_excel("Hampshire/Anonymised- Op Sentry - Stage 1 Hampshire Complete RE.xlsx", sheet = 3)
names(hamps_int) = gsub(" ", ".", names(hamps_int)) %>%
gsub(pattern ="(", replacement= "", fixed=T) %>%
gsub(pattern=")", replacement = "", fixed=T) %>%
gsub(pattern="/", replacement = "", fixed=T) %>%
gsub(pattern=",", replacement = "", fixed=T)
# str(hamps)
hamps_int %>% kable() %>% kable_styling("striped") %>% scroll_box(width="900px", height="600px")
hamps_int = hamps_int[!(hamps_int$victim.sex == "Male"),]
hamps_int = hamps_int[grep("HETEROSEXUAL", hamps_int$`Relationship.to.victim.partner.or.ex-partner`),]
hamps_comp1a = read_excel("Hampshire/Domestic - Performance Summary Phase 2 Final.xlsx", sheet=1, skip=2)
hamps_comp2a = read_excel("Hampshire/Domestic - Performance Summary Phase 2 Final.xlsx", sheet=2, skip=2)
hamps_comp3a = read_excel("Hampshire/Domestic - Performance Summary Phase 2 Final.xlsx", sheet=3, skip=2)
hamps_comp4a = read_excel("Hampshire/Domestic - Performance Summary Phase 2 Final.xlsx", sheet=4, skip=2)
hamps_comp5a = read_excel("Hampshire/Domestic - Performance Summary Phase 2 Final.xlsx", sheet=5, skip=2)
hamps_comp1b = read_excel("Hampshire/Domestic - Performance Summary Phase 2 Final 021023_081023.xlsx", sheet=1, skip=2)
hamps_comp2b = read_excel("Hampshire/Domestic - Performance Summary Phase 2 Final 021023_081023.xlsx", sheet=2, skip=2)
hamps_comp3b = read_excel("Hampshire/Domestic - Performance Summary Phase 2 Final 021023_081023.xlsx", sheet=3, skip=2)
hamps_comp4b = read_excel("Hampshire/Domestic - Performance Summary Phase 2 Final 021023_081023.xlsx", sheet=4, skip=2)
hamps_comp5b = read_excel("Hampshire/Domestic - Performance Summary Phase 2 Final 021023_081023.xlsx", sheet=5, skip=2)
names(hamps_comp1a) = sprintf("%s_agg", names(hamps_comp1a)) %>% gsub(pattern = " ", replacement = "_")
names(hamps_comp1b) = sprintf("%s_agg", names(hamps_comp1b)) %>% gsub(pattern = " ", replacement = "_")
names(hamps_comp2a) = sprintf("%s_sus", names(hamps_comp2a)) %>% gsub(pattern = " ", replacement = "_")
names(hamps_comp2b) = sprintf("%s_sus", names(hamps_comp2b)) %>% gsub(pattern = " ", replacement = "_")
names(hamps_comp3a) = sprintf("%s_outcome", names(hamps_comp3a)) %>% gsub(pattern = " ", replacement = "_")
names(hamps_comp3b) = sprintf("%s_outcome", names(hamps_comp3b)) %>% gsub(pattern = " ", replacement = "_")
names(hamps_comp4a) = sprintf("%s_aggprev", names(hamps_comp4a)) %>% gsub(pattern = " ", replacement = "_")
names(hamps_comp4b) = sprintf("%s_aggprev", names(hamps_comp4b)) %>% gsub(pattern = " ", replacement = "_")
names(hamps_comp5a) = sprintf("%s_susprev", names(hamps_comp5a)) %>% gsub(pattern = " ", replacement = "_")
names(hamps_comp5b) = sprintf("%s_susprev", names(hamps_comp5b)) %>% gsub(pattern = " ", replacement = "_")
vic_rep = hamps_comp1a$C_Nominal_Number_agg[hamps_comp1a$C_Nominal_Number_agg %in% hamps_comp1b$C_Nominal_Number_agg]
hamps_comp1 = rbind(hamps_comp1a, hamps_comp1b[ ,-16])
hamps_comp1[hamps_comp1$C_Nominal_Number_agg%in%vic_rep,] %>% kable %>%
scroll_box(width= "900px")
hamps_comp1b_nrep = hamps_comp1b[!(hamps_comp1b$C_Nominal_Number_agg%in%vic_rep),]
hamps_comp1 = rbind(hamps_comp1a, hamps_comp1b_nrep[ ,-16])
hamps_comp1 = hamps_comp1[hamps_comp1$`Gender_Code_(IP)_agg` == "F",]
hamps_comp1 = hamps_comp1[hamps_comp1$`Off_/_Victim_Relationship_agg` %in%c("EX-PARTNER: HETEROSEXUAL", "PARTNER: HETEROSEXUAL"),]
dim(hamps_comp1)
length(unique(hamps_comp1$C_Nominal_Number_agg))
hamps_vicID_dup = hamps_comp1$C_Nominal_Number_agg[duplicated(hamps_comp1a$C_Nominal_Number_agg)]
hamps_vicID_dup
hamps_comp1[hamps_comp1$C_Nominal_Number_agg %in% hamps_vicID_dup,] %>% kable %>%
scroll_box(width = "900px")
hamps_comp1 = hamps_comp1[!duplicated(hamps_comp1$C_Nominal_Number_agg),]
any(duplicated(hamps_comp1$C_Nominal_Number_agg))
hamps_comp2 = rbind(hamps_comp2a, hamps_comp2b[-18])
hamps_comp2 = hamps_comp2[hamps_comp2$`Off_/_Victim_Relationship_sus` %in%c("EX-PARTNER: HETEROSEXUAL", "PARTNER: HETEROSEXUAL"),]
hamps_comp_12 = full_join(hamps_comp1, hamps_comp2, by = join_by(Occurrence_No_agg == Occurrence_No_sus), relationship = "many-to-many")
dim(hamps_comp_12)
hamps_comp_12 = hamps_comp_12[!is.na(hamps_comp_12$C_Nominal_Number_sus),]
hamps_comp_12 = hamps_comp_12[!is.na(hamps_comp_12$C_Nominal_Number_agg),]
hamps_occID_dup = hamps_comp_12$Occurrence_No_agg[duplicated(hamps_comp_12$Occurrence_No_agg)]
hamps_comp_12[hamps_comp_12$Occurrence_No_agg %in% hamps_occID_dup,] %>% kable %>%
scroll_box(width="900px", height = "600px")
hamps_comp_12 = hamps_comp_12[!duplicated(hamps_comp_12$Occurrence_No_agg),]
hamps_susID_dup = hamps_comp_12$C_Nominal_Number_sus[duplicated(hamps_comp_12$C_Nominal_Number_sus)]
hamps_comp_12[hamps_comp_12$C_Nominal_Number_sus %in% hamps_susID_dup,] %>% kable %>%
scroll_box(width="900px", height = "600px")
hamps_comp_12 = hamps_comp_12[!duplicated(hamps_comp_12$C_Nominal_Number_sus),]
vis_dat(hamps_comp_12, sort_type = F)
hamps_comp_12 = hamps_comp_12[hamps_comp_12$`Gender_Code_(IP)_sus` == "M",]
hamps_comp_12 = hamps_comp_12[!(is.na(hamps_comp_12$Occ_Type_agg)),]
hamps_int_df = data.frame(
victim_ID = hamps_int$Victim.Unique.ID.CoP,
victim_sex = hamps_int$victim.sex,
victim_age = hamps_int$Victim.age.at.time.of.incident,
victim_ethnicity = hamps_int$victim.ethnicity.where.recorded
)
gtsummary::tbl_summary(hamps_int_df[ ,2:4])
hamps_comp_df = data.frame(
victim_ID = hamps_comp_12$C_Nominal_Number_agg,
victim_sex = hamps_comp_12$`Gender_Code_(IP)_agg`,
victim_age = hamps_comp_12$Age_agg,
victim_ethnicity = hamps_comp_12$SD_Ethnicity_agg
)
gtsummary::tbl_summary(hamps_comp_df[ ,2:4])
hamps_int_df$suspect_ID = hamps_int$Suspect.Unique.ID
hamps_int_df$suspect_sex = hamps_int$Suspect.Sex
hamps_int_df$suspect_age = hamps_int$Suspect.Age.at.time.of.incident
hamps_int_df$suspect_ethnicity = hamps_int$Suspect.ethnicity
gtsummary::tbl_summary(hamps_int_df[ ,6:8])
hamps_comp_df$suspect_ID = hamps_comp_12$C_Nominal_Number_sus
hamps_comp_df$suspect_sex = hamps_comp_12$`Gender_Code_(IP)_sus`
hamps_comp_df$suspect_age = hamps_comp_12$Age_sus
hamps_comp_df$suspect_ethnicity = hamps_comp_12$SD_Ethnicity_sus
gtsummary::tbl_summary(hamps_comp_df[ ,6:8])
hamps_int_df$police_force = hamps_int$Police.force
hamps_int_df$police_district = hamps_int$Police.force.district.of.address.where.products.are.issued
hamps_int_df$police_district = gsub("^New Forest.+", "New Forest", hamps_int_df$police_district) # tidy up New Forest
table(hamps_int_df$police_district)
hamps_comp_df$police_force = hamps_comp_12$police_force = "Hampshire and Isle of Wight Constabulary"
hamps_comp_df$police_district = hamps_comp_12$District_Name_agg
hamps_inc_types = read.csv(file = "Hampshire/inc_types_hamps.csv", header=T)
hamps_inc_types %>% kable %>% kable_styling("striped") %>%
scroll_box(height = "600px")
hamps_int_df$date_latest = as.Date(hamps_int$Date.of.Incident.that.has.resulted.in.products.being.offered.Latest.date, format = "%d/%m/%Y")
summary(hamps_int_df$date_latest)
hamps_int_df$date_warning = as.Date(as.numeric(hamps_int$Date.warning.delivered, origin = "1899-12-30"))
summary(hamps_int_df$date_warning)
hamps_int_df$incident_type_raw = toupper(hamps_int$INCIDENT.TYPE.RECODED)
hamps_int_df$category = sapply(
1:nrow(hamps_int_df),
function(i){
hamps_inc_types$category[hamps_inc_types$inc_type == hamps_int_df$incident_type_raw[i]][1]
}
)
hamps_int_df$violent_SO = hamps_int_df$category == "violent_SO"
hamps_int_df$CoC = hamps_int_df$category == "CoC"
hamps_int_df$theft_CD = hamps_int_df$category == "theft_CD"
hamps_int_df$breach = hamps_int_df$category == "breach"
hamps_int_df[,13:17] %>% kable() %>% kable_styling("striped") %>%
scroll_box(width="900px", height = "600px")
sum(hamps_comp_12$`Start_Date_(SD_Adj)_agg`!=hamps_comp_12$`Start_Date_(SD_Adj)_sus`, na.rm=T)
hamps_comp_df$date_latest = as.Date(hamps_comp_12$`Start_Date_(SD_Adj)_agg`, format = "%Y-%m-%d")
summary(hamps_comp_df$date_latest)
hamps_comp_df$date_warning = NA
sum(hamps_comp_12$Occ_Type_agg != hamps_comp_12$Occ_Type_sus, na.rm = T)
hamps_comp_df$incident_type_raw = toupper(hamps_comp_12$Occ_Type_agg)
hamps_comp_df$category = sapply(
1:nrow(hamps_comp_df),
function(i){
hamps_inc_types$category[hamps_inc_types$inc_type == hamps_comp_df$incident_type_raw[i]][1]
}
)
hamps_comp_df$violent_SO = hamps_comp_df$category == "violent_SO"
hamps_comp_df$CoC = hamps_comp_df$category == "CoC"
hamps_comp_df$theft_CD = hamps_comp_df$category == "theft_CD"
hamps_comp_df$breach = hamps_comp_df$category == "breach"
hamps_comp_df[,13:17] %>% kable() %>% kable_styling("striped") %>%
scroll_box(width="900px", height = "600px")
names(hamps_int)
names(hamps_comp_12)
hamps_int_df$Incident_ID = NA
hamps_comp_df$Incident_ID = hamps_comp_12$Occurrence_No_agg
names(hamps_comp_df)
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(ggplot2)
library(gridExtra)
library(kableExtra)
library(readr)
library(readxl)
library(tidyverse)
library(visdat)
library(reshape2)
library(gtsummary)
require(utf8)
# setwd("/Users/rachelo/OneDrive - Durham University/AP2020_21/Projects/CoP/SmartWater/FM_analysis/")
# hamps_int = read.csv("Hampshire/Anonymised- Op Sentry - Stage 1 Hampshire Complete RE(REVISEDproject management data).csv", header=T)
hamps_int = read_excel("Hampshire/Anonymised- Op Sentry - Stage 1 Hampshire Complete RE.xlsx", sheet = 3)
names(hamps_int) = gsub(" ", ".", names(hamps_int)) %>%
gsub(pattern ="(", replacement= "", fixed=T) %>%
gsub(pattern=")", replacement = "", fixed=T) %>%
gsub(pattern="/", replacement = "", fixed=T) %>%
gsub(pattern=",", replacement = "", fixed=T)
# str(hamps)
hamps_int %>% kable() %>% kable_styling("striped") %>% scroll_box(width="900px", height="600px")
hamps_int = hamps_int[!(hamps_int$victim.sex == "Male"),]
hamps_int = hamps_int[grep("HETEROSEXUAL", hamps_int$`Relationship.to.victim.partner.or.ex-partner`),]
hamps_comp1a = read_excel("Hampshire/Domestic - Performance Summary Phase 2 Final.xlsx", sheet=1, skip=2)
hamps_comp2a = read_excel("Hampshire/Domestic - Performance Summary Phase 2 Final.xlsx", sheet=2, skip=2)
hamps_comp3a = read_excel("Hampshire/Domestic - Performance Summary Phase 2 Final.xlsx", sheet=3, skip=2)
hamps_comp4a = read_excel("Hampshire/Domestic - Performance Summary Phase 2 Final.xlsx", sheet=4, skip=2)
hamps_comp5a = read_excel("Hampshire/Domestic - Performance Summary Phase 2 Final.xlsx", sheet=5, skip=2)
hamps_comp1b = read_excel("Hampshire/Domestic - Performance Summary Phase 2 Final 021023_081023.xlsx", sheet=1, skip=2)
hamps_comp2b = read_excel("Hampshire/Domestic - Performance Summary Phase 2 Final 021023_081023.xlsx", sheet=2, skip=2)
hamps_comp3b = read_excel("Hampshire/Domestic - Performance Summary Phase 2 Final 021023_081023.xlsx", sheet=3, skip=2)
hamps_comp4b = read_excel("Hampshire/Domestic - Performance Summary Phase 2 Final 021023_081023.xlsx", sheet=4, skip=2)
hamps_comp5b = read_excel("Hampshire/Domestic - Performance Summary Phase 2 Final 021023_081023.xlsx", sheet=5, skip=2)
names(hamps_comp1a) = sprintf("%s_agg", names(hamps_comp1a)) %>% gsub(pattern = " ", replacement = "_")
names(hamps_comp1b) = sprintf("%s_agg", names(hamps_comp1b)) %>% gsub(pattern = " ", replacement = "_")
names(hamps_comp2a) = sprintf("%s_sus", names(hamps_comp2a)) %>% gsub(pattern = " ", replacement = "_")
names(hamps_comp2b) = sprintf("%s_sus", names(hamps_comp2b)) %>% gsub(pattern = " ", replacement = "_")
names(hamps_comp3a) = sprintf("%s_outcome", names(hamps_comp3a)) %>% gsub(pattern = " ", replacement = "_")
names(hamps_comp3b) = sprintf("%s_outcome", names(hamps_comp3b)) %>% gsub(pattern = " ", replacement = "_")
names(hamps_comp4a) = sprintf("%s_aggprev", names(hamps_comp4a)) %>% gsub(pattern = " ", replacement = "_")
names(hamps_comp4b) = sprintf("%s_aggprev", names(hamps_comp4b)) %>% gsub(pattern = " ", replacement = "_")
names(hamps_comp5a) = sprintf("%s_susprev", names(hamps_comp5a)) %>% gsub(pattern = " ", replacement = "_")
names(hamps_comp5b) = sprintf("%s_susprev", names(hamps_comp5b)) %>% gsub(pattern = " ", replacement = "_")
vic_rep = hamps_comp1a$C_Nominal_Number_agg[hamps_comp1a$C_Nominal_Number_agg %in% hamps_comp1b$C_Nominal_Number_agg]
hamps_comp1 = rbind(hamps_comp1a, hamps_comp1b[ ,-16])
hamps_comp1[hamps_comp1$C_Nominal_Number_agg%in%vic_rep,] %>% kable %>%
scroll_box(width= "900px")
hamps_comp1b_nrep = hamps_comp1b[!(hamps_comp1b$C_Nominal_Number_agg%in%vic_rep),]
hamps_comp1 = rbind(hamps_comp1a, hamps_comp1b_nrep[ ,-16])
hamps_comp1 = hamps_comp1[hamps_comp1$`Gender_Code_(IP)_agg` == "F",]
hamps_comp1 = hamps_comp1[hamps_comp1$`Off_/_Victim_Relationship_agg` %in%c("EX-PARTNER: HETEROSEXUAL", "PARTNER: HETEROSEXUAL"),]
dim(hamps_comp1)
length(unique(hamps_comp1$C_Nominal_Number_agg))
hamps_vicID_dup = hamps_comp1$C_Nominal_Number_agg[duplicated(hamps_comp1a$C_Nominal_Number_agg)]
hamps_vicID_dup
hamps_comp1[hamps_comp1$C_Nominal_Number_agg %in% hamps_vicID_dup,] %>% kable %>%
scroll_box(width = "900px")
hamps_comp1 = hamps_comp1[!duplicated(hamps_comp1$C_Nominal_Number_agg),]
any(duplicated(hamps_comp1$C_Nominal_Number_agg))
hamps_comp2 = rbind(hamps_comp2a, hamps_comp2b[-18])
hamps_comp2 = hamps_comp2[hamps_comp2$`Off_/_Victim_Relationship_sus` %in%c("EX-PARTNER: HETEROSEXUAL", "PARTNER: HETEROSEXUAL"),]
hamps_comp_12 = full_join(hamps_comp1, hamps_comp2, by = join_by(Occurrence_No_agg == Occurrence_No_sus), relationship = "many-to-many")
dim(hamps_comp_12)
hamps_comp_12 = hamps_comp_12[!is.na(hamps_comp_12$C_Nominal_Number_sus),]
hamps_comp_12 = hamps_comp_12[!is.na(hamps_comp_12$C_Nominal_Number_agg),]
hamps_occID_dup = hamps_comp_12$Occurrence_No_agg[duplicated(hamps_comp_12$Occurrence_No_agg)]
hamps_comp_12[hamps_comp_12$Occurrence_No_agg %in% hamps_occID_dup,] %>% kable %>%
scroll_box(width="900px", height = "600px")
hamps_comp_12 = hamps_comp_12[!duplicated(hamps_comp_12$Occurrence_No_agg),]
hamps_susID_dup = hamps_comp_12$C_Nominal_Number_sus[duplicated(hamps_comp_12$C_Nominal_Number_sus)]
hamps_comp_12[hamps_comp_12$C_Nominal_Number_sus %in% hamps_susID_dup,] %>% kable %>%
scroll_box(width="900px", height = "600px")
hamps_comp_12 = hamps_comp_12[!duplicated(hamps_comp_12$C_Nominal_Number_sus),]
vis_dat(hamps_comp_12, sort_type = F)
hamps_comp_12 = hamps_comp_12[hamps_comp_12$`Gender_Code_(IP)_sus` == "M",]
hamps_comp_12 = hamps_comp_12[!(is.na(hamps_comp_12$Occ_Type_agg)),]
hamps_int_df = data.frame(
victim_ID = hamps_int$Victim.Unique.ID.CoP,
victim_sex = hamps_int$victim.sex,
victim_age = hamps_int$Victim.age.at.time.of.incident,
victim_ethnicity = hamps_int$victim.ethnicity.where.recorded
)
gtsummary::tbl_summary(hamps_int_df[ ,2:4])
hamps_comp_df = data.frame(
victim_ID = hamps_comp_12$C_Nominal_Number_agg,
victim_sex = hamps_comp_12$`Gender_Code_(IP)_agg`,
victim_age = hamps_comp_12$Age_agg,
victim_ethnicity = hamps_comp_12$SD_Ethnicity_agg
)
gtsummary::tbl_summary(hamps_comp_df[ ,2:4])
hamps_int_df$suspect_ID = hamps_int$Suspect.Unique.ID
hamps_int_df$suspect_sex = hamps_int$Suspect.Sex
hamps_int_df$suspect_age = hamps_int$Suspect.Age.at.time.of.incident
hamps_int_df$suspect_ethnicity = hamps_int$Suspect.ethnicity
gtsummary::tbl_summary(hamps_int_df[ ,6:8])
hamps_comp_df$suspect_ID = hamps_comp_12$C_Nominal_Number_sus
hamps_comp_df$suspect_sex = hamps_comp_12$`Gender_Code_(IP)_sus`
hamps_comp_df$suspect_age = hamps_comp_12$Age_sus
hamps_comp_df$suspect_ethnicity = hamps_comp_12$SD_Ethnicity_sus
gtsummary::tbl_summary(hamps_comp_df[ ,6:8])
hamps_int_df$police_force = hamps_int$Police.force
hamps_int_df$police_district = hamps_int$Police.force.district.of.address.where.products.are.issued
hamps_int_df$police_district = gsub("^New Forest.+", "New Forest", hamps_int_df$police_district) # tidy up New Forest
table(hamps_int_df$police_district)
hamps_comp_df$police_force = hamps_comp_12$police_force = "Hampshire and Isle of Wight Constabulary"
hamps_comp_df$police_district = hamps_comp_12$District_Name_agg
hamps_inc_types = read.csv(file = "Hampshire/inc_types_hamps.csv", header=T)
hamps_inc_types %>% kable %>% kable_styling("striped") %>%
scroll_box(height = "600px")
hamps_int_df$date_latest = as.Date(hamps_int$Date.of.Incident.that.has.resulted.in.products.being.offered.Latest.date, format = "%d/%m/%Y")
summary(hamps_int_df$date_latest)
hamps_int_df$date_warning = as.Date(as.numeric(hamps_int$Date.warning.delivered, origin = "1899-12-30"))
summary(hamps_int_df$date_warning)
hamps_int_df$incident_type_raw = toupper(hamps_int$INCIDENT.TYPE.RECODED)
hamps_int_df$category = sapply(
1:nrow(hamps_int_df),
function(i){
hamps_inc_types$category[hamps_inc_types$inc_type == hamps_int_df$incident_type_raw[i]][1]
}
)
hamps_int_df$violent_SO = hamps_int_df$category == "violent_SO"
hamps_int_df$CoC = hamps_int_df$category == "CoC"
hamps_int_df$theft_CD = hamps_int_df$category == "theft_CD"
hamps_int_df$breach = hamps_int_df$category == "breach"
hamps_int_df[,13:17] %>% kable() %>% kable_styling("striped") %>%
scroll_box(width="900px", height = "600px")
sum(hamps_comp_12$`Start_Date_(SD_Adj)_agg`!=hamps_comp_12$`Start_Date_(SD_Adj)_sus`, na.rm=T)
hamps_comp_df$date_latest = as.Date(hamps_comp_12$`Start_Date_(SD_Adj)_agg`, format = "%Y-%m-%d")
summary(hamps_comp_df$date_latest)
hamps_comp_df$date_warning = NA
sum(hamps_comp_12$Occ_Type_agg != hamps_comp_12$Occ_Type_sus, na.rm = T)
hamps_comp_df$incident_type_raw = toupper(hamps_comp_12$Occ_Type_agg)
hamps_comp_df$category = sapply(
1:nrow(hamps_comp_df),
function(i){
hamps_inc_types$category[hamps_inc_types$inc_type == hamps_comp_df$incident_type_raw[i]][1]
}
)
hamps_comp_df$violent_SO = hamps_comp_df$category == "violent_SO"
hamps_comp_df$CoC = hamps_comp_df$category == "CoC"
hamps_comp_df$theft_CD = hamps_comp_df$category == "theft_CD"
hamps_comp_df$breach = hamps_comp_df$category == "breach"
hamps_comp_df[,13:17] %>% kable() %>% kable_styling("striped") %>%
scroll_box(width="900px", height = "600px")
hamps_int_df$Incident_ID = NA
hamps_comp_df$Incident_ID = hamps_comp_12$Occurrence_No_agg
hamps_int_df$FM_equip = T
hamps_int_df$warning_YN = "No"
hamps_int_df$warning_YN[hamps_int$Warning.delivered.to.Suspect.yn == "Yes"] = "Yes"
hamps_comp_df$FM_equip = F
hamps_comp_df$warning_YN = NA
table(hamps_int$Risk.Assessment.from.DASH.standard.medium.or.high)
hamps_int_df$risk_ass = NA
hamps_int_df$risk_ass[hamps_int$Risk.Assessment.from.DASH.standard.medium.or.high == "HIGH"] = "HIGH"
hamps_int_df$risk_ass[hamps_int$Risk.Assessment.from.DASH.standard.medium.or.high == "MEDIUM"] = "MEDIUM"
table(hamps_int_df$risk_ass)
table(hamps_comp_12$`Risk_(Detail)_-_Incidents_SUS_OFF_sus`)
hamps_comp_df$risk_ass = hamps_comp_12$`Risk_(Detail)_-_Incidents_SUS_OFF_sus`
table(hamps_comp_df$risk_ass)
hamps_int_df$protection_order = rep("Yes", nrow(hamps_int_df))
hamps_comp_po = read.csv(file = "Hampshire/Op Sentry Evaluation PO_BO Conditions_Cara.csv", header=T)
hamps_comp_po_only = na.omit(hamps_comp_po[ ,c(5,29:31)])
hamps_comp_po_only$suspect_ID = as.character(hamps_comp_po_only$suspect_ID)
prot_comp_tmp = data.frame(suspect_ID = as.character(hamps_comp_df$suspect_ID))
prot_comp_tmp_po = left_join(prot_comp_tmp, hamps_comp_po_only, by = "suspect_ID")
prot_comp_tmp_po$protection_order = sapply(
1:nrow(prot_comp_tmp_po),
function(i){
any(c(prot_comp_tmp_po$PO.Conditions.[i]=="Y", prot_comp_tmp_po$Bail.Conditions.[i] == "Y"))
}
)
prot_comp_tmp_po$suspect_ID = as.character(prot_comp_tmp_po$suspect_ID)
hamps_comp_df = left_join(x=hamps_comp_df, y=prot_comp_tmp_po[,c(1,5)], by = "suspect_ID")
hamps_comp_df[,c(1,5,23)] %>% kable %>% kable_styling("striped") %>%
scroll_box(width="900px", height = "600px")
hamps_int_df$nprev_sus = hamps_int$no.of.previous.offences
hamps_int_df$typeprev_sus = hamps_int$`Suspect.-.previous.DA.incidents.over.the.past.12.months.incident.type.-.Incident.types.seperated.by.";"`
hamps_int_prev = hamps_int[,34]
names(hamps_int_prev) = "sus_prev"
hamps_int_susprev_list = strsplit(hamps_int_prev$sus_prev, split = ";")
hamps_int_susprev_list = lapply(hamps_int_susprev_list, gsub, pattern = "^ ", replace = "")
hamps_int_susprev_list = lapply(hamps_int_susprev_list, gsub, pattern = " $", replace = "")
CoCprev = rep(NA, nrow(hamps_int_df))
violentprev = rep(NA, nrow(hamps_int_df))
for (i in 1:nrow(hamps_int_df)){
susprev_i = hamps_int$`Suspect.-.previous.DA.incidents.over.the.past.12.months.incident.type.-.Incident.types.seperated.by.";"`[i]
types_i = strsplit(susprev_i, split = ";")[[1]]
types_i = gsub(pattern = "^ ", replacement = "", types_i)
types_i = gsub(pattern = " $", replacement = "", types_i)
## CHECK!
CoCprev[i] = any(types_i %in% hamps_inc_types$inc_type[hamps_inc_types$category == "CoC"])
violentprev[i] = any(types_i %in% hamps_inc_types$inc_type[hamps_inc_types$category == "violent_SO"])
}
hamps_int_df$CoC_susprev = CoCprev
hamps_int_df$violent_SO_susprev = violentprev
hamps_int_df[,c(5,24:26)] %>% kable() %>% kable_styling("striped") %>%
scroll_box(height = "600px")
hamps_int_prev_unique = sort(unique(unlist(hamps_int_susprev_list)))
hamps_comp5 = rbind(hamps_comp5a, hamps_comp5b[,-8])
nrow(hamps_comp5)
length(unique(hamps_comp5$Occurrence_No_susprev))
susprev_comp_dupocc = hamps_comp5$Occurrence_No_susprev[duplicated(hamps_comp5$Occurrence_No_susprev)]
hamps_comp5[hamps_comp5$Occurrence_No_susprev %in% susprev_comp_dupocc,]%>%
kable() %>%
scroll_box(width = "900px")
hamps_comp5 = hamps_comp5[!duplicated(hamps_comp5$Occurrence_No_susprev),]
nprev_sus_comp = rep(NA, nrow(hamps_comp_df))
typeprev_sus_comp = rep(NA, nrow(hamps_comp_df))
for(i in 1:nrow(hamps_comp_df)){
hamps_comp5_i = hamps_comp5[hamps_comp5$C_Nominal_Number_susprev == hamps_comp_df$suspect_ID[i], ]
nprev_sus_comp[i] = length(unique(hamps_comp5_i$Occurrence_No_susprev))
typeprev_sus_comp[i] = paste(unique(hamps_comp5_i$Occ_Type_susprev), collapse = ";")
}
hamps_comp_df$nprev_sus = nprev_sus_comp
hamps_comp_df$typeprev_sus = typeprev_sus_comp
CoCprev = rep(NA, nrow(hamps_comp_df))
violentprev = rep(NA, nrow(hamps_comp_df))
for (i in 1:nrow(hamps_comp_df)){
susprev_i = hamps_comp_df$typeprev_sus[i]
types_i = strsplit(susprev_i, split = ";")[[1]]
types_i = gsub(pattern = "^ ", replacement = "", types_i)
types_i = gsub(pattern = " $", replacement = "", types_i)
## CHECK!
CoCprev[i] = any(types_i %in% hamps_inc_types$inc_type[hamps_inc_types$category == "CoC"])
violentprev[i] = any(types_i %in% hamps_inc_types$inc_type[hamps_inc_types$category == "violent_SO"])
}
hamps_comp_df$CoC_susprev = CoCprev
hamps_comp_df$violent_SO_susprev = violentprev
hamps_comp_df[,c(5,24:26)] %>% kable() %>% kable_styling("striped") %>%
scroll_box(height = "600px")
hamps_df = rbind(hamps_int_df, hamps_comp_df)
psm_hamps1 = glm(
FM_equip ~ suspect_age + CoC  + nprev_sus + risk_ass + CoC_susprev + violent_SO_susprev,
data = hamps_df,
family = binomial(link="logit"))
tbl_regression(psm_hamps1)
hamps_po = predict(
object = psm_hamps1,
newdata = hamps_df,
type = "response"
)
hamps_df$propensity_score = hamps_po
ggplot(data=hamps_df, aes(x=propensity_score, fill = FM_equip)) +
geom_histogram(position = "dodge") +
xlab("Propensity Score (not accounting for protection order)") + scale_x_continuous(breaks = seq(0,1,by=0.1))
vis_dat(hamps_df[,c(7,16,23,21,25,26)], sort_type = F)
psm_hamps2 = glm(
FM_equip ~ CoC  + nprev_sus + risk_ass + CoC_susprev + violent_SO_susprev,
data = hamps_df,
family = binomial(link="logit"))
tbl_regression(psm_hamps2)
psm_hamps3 = glm(
FM_equip ~ CoC  + nprev_sus + risk_ass + CoC_susprev,
data = hamps_df,
family = binomial(link="logit"))
tbl_regression(psm_hamps3)
hamps_po3 = predict(
object = psm_hamps3,
newdata = hamps_df,
type = "response"
)
hamps_df$propensity_score3 = hamps_po3
ggplot(data=hamps_df, aes(x=propensity_score3, fill = FM_equip)) +
geom_histogram(position = "dodge") +
xlab("Propensity Score 3 (not accounting for protection order)") + scale_x_continuous(breaks = seq(0,1,by=0.1))
min(hamps_df$propensity_score3[hamps_df$FM_equip == T], na.rm=T)
hamps_cutoff_0_015 = hamps_df[(hamps_df$propensity_score3>0.015)&(!is.na(hamps_df$propensity_score3)),]
nrow(hamps_cutoff_0_015[hamps_cutoff_0_015$FM_equip ==F,])
hamps_cutoff_0_015 %>% kable %>% kable_styling("striped") %>%
scroll_box(width="900px", height = "600px")
names(hamps_cutoff_0_015)
write_excel_csv(hamps_cutoff_0_015, file = "Hampshire/PSM_comparisongroup_30Jan.csv", quote=NULL)
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(ggplot2)
library(gridExtra)
library(kableExtra)
library(readr)
library(readxl)
library(tidyverse)
library(visdat)
library(reshape2)
library(gtsummary)
setwd("/Users/rachelo/OneDrive - Durham University/AP2020_21/Projects/CoP/SmartWater/FM_analysis/")
# setwd("/Users/rachelo/OneDrive - Durham University/AP2020_21/Projects/CoP/SmartWater/FM_analysis/")
wy_int = read_excel(path = "WestYorks/WYP Intervention group - FINAL - 06-01-2025.xlsx", sheet=3)
wy_int = wy_int[!is.na(wy_int$`Victim Unique ID`),] # remove missing rows
wy_int = wy_int[wy_int$`include in analysis? (Y/N-reason)` == "Y",]
wy_int = wy_int[wy_int$`victim sex` == "Female",]
dim(wy_int)
table(wy_int$`relationship recoded`)
wy_comp = read_excel("WestYorks/WY Smartwater Stage 1 Comparison Group RE.xlsx", sheet=1)
names(wy_comp) = gsub("\\.+", ".", names(wy_comp))
table(wy_comp$gender.2)
wy_comp = wy_comp[wy_comp$gender.2 == "F",]
table(wy_comp$relationship_to_victim)
IP_comp_ind = c(
grep("PARTNER", wy_comp$relationship_to_victim),
grep("SPOUSE", wy_comp$relationship_to_victim))
wy_notIP = wy_comp[-IP_comp_ind, ]
wy_comp = wy_comp[IP_comp_ind,
]
table(wy_comp$relationship_to_victim)
table(wy_notIP$relationship_to_victim)
length(wy_comp$nominal_ref.1)
length(unique(wy_comp$nominal_ref.1))
n_vic_ID = length(unique(wy_comp$nominal_ref.1))
dup_ID = integer(0)
for (i in 1:n_vic_ID){
id_i = unique(wy_comp$nominal_ref.1)[i]
df_ID_i = wy_comp[wy_comp$nominal_ref.1 == id_i,]
if(nrow(df_ID_i)>1){
dup_ID = c(dup_ID, id_i)
}
}
wy_comp_dup = wy_comp[wy_comp$nominal_ref.1 %in% dup_ID,]
wy_comp[wy_comp$nominal_ref.1 %in% dup_ID,]%>% kable() %>%
scroll_box(width="900px", height = "500px")
q()
